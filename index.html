<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ğŸµ í˜ì´ì§€ ë‚´ ìœ íŠœë¸Œ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸</title>
  <style>
    body { font-family: sans-serif; max-width: 900px; margin: 20px auto; }
    input, button, select { padding: 8px; margin: 5px; font-size: 16px; }
    ul { list-style: none; padding: 0; }
    li { background: #f9f9f9; margin: 8px 0; padding: 8px; display: flex; align-items: center; border: 1px solid #ccc; border-radius: 6px; gap: 10px; }
    .song-title { flex-grow: 1; color: blue; cursor: pointer; text-decoration: underline; }
    img.thumbnail { width: 80px; height: 45px; object-fit: cover; border-radius: 4px; }
    .controls button { margin-left: 4px; }
    #playerContainer { text-align: center; margin-top: 20px; }
    #currentSongTitle { font-weight: bold; margin-top: 10px; min-height: 1.5em; }
    #playlistHeader { display: flex; align-items: center; gap: 10px; }
  </style>
</head>
<body>
  <h2>ğŸµ í˜ì´ì§€ ë‚´ ìœ íŠœë¸Œ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸</h2>

  <div id="playlistHeader">
    <select id="playlistSelect"></select>
    <input type="text" id="newPlaylistName" placeholder="ìƒˆ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì´ë¦„">
    <button onclick="createPlaylist()">â• ìƒì„±</button>
    <button onclick="deletePlaylist()">ğŸ—‘ ì‚­ì œ</button>
    <span id="playlistTitleDisplay"></span>
    <button onclick="editTitle()">âœï¸ ìˆ˜ì •</button>
  </div>

  <input type="text" id="urlInput" placeholder="ìœ íŠœë¸Œ ë§í¬ ë˜ëŠ” ID ì…ë ¥" style="width: 100%;">
  <button onclick="addSong()">ğŸ¶ ì¶”ê°€</button>
  <button onclick="selectAll(true)">â˜‘ ì „ì²´ ì„ íƒ</button>
  <button onclick="selectAll(false)">â˜ ì „ì²´ í•´ì œ</button>
  <input type="number" id="repeatCount" min="1" value="1" style="width: 80px;">íšŒ ë°˜ë³µ
  <button onclick="playSelected()">â–¶ ì„ íƒ ì¬ìƒ</button>

  <ul id="playlist"></ul>

  <div id="playerContainer">
    <div id="player"></div>
    <div id="currentSongTitle"></div>
    <div>
      <button onclick="prevSong()">â® ì´ì „ê³¡</button>
      <button onclick="togglePlayPause()" id="playPauseBtn">âµ ì¬ìƒ</button>
      <button onclick="nextSong()">â­ ë‹¤ìŒê³¡</button>
    </div>
  </div>

<script>
let playlists = JSON.parse(localStorage.getItem('playlists') || '[]');
let currentPlaylistIndex = 0;
let playingList = [], currentPlayIndex = 0;
let player, isPlaying = false;
let repeatLimit = 1, currentRepeat = 0;

function savePlaylists() {
  localStorage.setItem('playlists', JSON.stringify(playlists));
  renderPlaylistSelect();
  renderSongs();
}

function renderPlaylistSelect() {
  const select = document.getElementById('playlistSelect');
  select.innerHTML = '';
  playlists.forEach((p, i) => {
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = p.title;
    select.appendChild(opt);
  });
  select.value = currentPlaylistIndex;
  document.getElementById('playlistTitleDisplay').textContent = `[â†’ ${playlists[currentPlaylistIndex]?.title || ''}]`;
}

function createPlaylist() {
  const name = document.getElementById('newPlaylistName').value.trim();
  if (!name) return alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
  playlists.push({ title: name, songs: [] });
  currentPlaylistIndex = playlists.length - 1;
  document.getElementById('newPlaylistName').value = '';
  savePlaylists();
}

function deletePlaylist() {
  if (playlists.length <= 1) return alert('ìµœì†Œ í•˜ë‚˜ëŠ” ë‚¨ê²¨ì•¼ í•©ë‹ˆë‹¤');
  if (confirm('ì •ë§ ì‚­ì œí• ê¹Œìš”?')) {
    playlists.splice(currentPlaylistIndex, 1);
    currentPlaylistIndex = 0;
    savePlaylists();
  }
}

function editTitle() {
  const newTitle = prompt('ìƒˆ ì œëª©:', playlists[currentPlaylistIndex].title);
  if (newTitle) {
    playlists[currentPlaylistIndex].title = newTitle;
    savePlaylists();
  }
}

document.getElementById('playlistSelect').onchange = (e) => {
  currentPlaylistIndex = parseInt(e.target.value);
  renderPlaylistSelect();
  renderSongs();
};

async function addSong() {
  const input = document.getElementById('urlInput');
  const id = extractVideoId(input.value);
  if (!id) return alert('ì˜ëª»ëœ ë§í¬ì…ë‹ˆë‹¤');
  const meta = await getYoutubeMeta(id);
  if (!meta) return alert('ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤');
  playlists[currentPlaylistIndex].songs.push({ id, ...meta });
  input.value = '';
  savePlaylists();
}

function renderSongs() {
  const ul = document.getElementById('playlist');
  ul.innerHTML = '';
  playlists[currentPlaylistIndex].songs.forEach((s, i) => {
    const li = document.createElement('li');
    li.innerHTML = `
      <input type="checkbox" class="song-checkbox" data-index="${i}">
      <img class="thumbnail" src="${s.thumb}">
      <span class="song-title" onclick="openInNewTab('${s.id}')">${s.title}</span>
      <button onclick="removeSong(${i})">ğŸ—‘</button>`;
    ul.appendChild(li);
  });
}

function openInNewTab(id) {
  window.open(`https://www.youtube.com/watch?v=${id}`, '_blank');
}

function removeSong(index) {
  playlists[currentPlaylistIndex].songs.splice(index, 1);
  savePlaylists();
}

function selectAll(state) {
  document.querySelectorAll('.song-checkbox').forEach(cb => cb.checked = state);
}

function extractVideoId(input) {
  input = input.trim();
  if (/^[\w-]{11}$/.test(input)) return input;
  try {
    const url = new URL(input);
    return url.hostname.includes('youtu.be') ? url.pathname.slice(1) : url.searchParams.get('v');
  } catch (e) { return null; }
}

async function getYoutubeMeta(id) {
  const res = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${id}&key=AIzaSyD5XkEw4xe9tN0b2pzU2lgiBap72NXiyYM`);
  const data = await res.json();
  const item = data.items?.[0];
  return item ? { title: item.snippet.title, thumb: item.snippet.thumbnails.default.url } : null;
}

function playSelected() {
  playingList = [];
  document.querySelectorAll('.song-checkbox').forEach(cb => {
    if (cb.checked) playingList.push(playlists[currentPlaylistIndex].songs[cb.dataset.index]);
  });
  if (playingList.length === 0) return alert('ê³¡ì„ ì„ íƒí•˜ì„¸ìš”');
  repeatLimit = parseInt(document.getElementById('repeatCount').value, 10) || 1;
  currentRepeat = 0;
  currentPlayIndex = 0;
  loadPlayer();
}

function loadPlayer() {
  if (player) player.loadVideoById(playingList[currentPlayIndex].id);
  else {
    player = new YT.Player('player', {
      height: '360', width: '640',
      videoId: playingList[currentPlayIndex].id,
      events: {
        onReady: e => e.target.playVideo(),
        onStateChange: onPlayerStateChange
      }
    });
  }
  updateTitle();
  isPlaying = true;
  document.getElementById('playPauseBtn').textContent = 'â¸ ì¼ì‹œì •ì§€';
}

function onPlayerStateChange(e) {
  if (e.data === YT.PlayerState.ENDED) {
    currentPlayIndex++;
    if (currentPlayIndex >= playingList.length) {
      currentRepeat++;
      if (currentRepeat < repeatLimit) {
        currentPlayIndex = 0;
      } else {
        return;
      }
    }
    loadPlayer();
  }
}

function updateTitle() {
  document.getElementById('currentSongTitle').textContent = playingList[currentPlayIndex]?.title || '';
}

function prevSong() {
  if (currentPlayIndex > 0) {
    currentPlayIndex--;
    loadPlayer();
  }
}

function nextSong() {
  if (currentPlayIndex < playingList.length - 1) {
    currentPlayIndex++;
    loadPlayer();
  }
}

function togglePlayPause() {
  if (!player) return;
  if (isPlaying) {
    player.pauseVideo();
    document.getElementById('playPauseBtn').textContent = 'âµ ì¬ìƒ';
  } else {
    player.playVideo();
    document.getElementById('playPauseBtn').textContent = 'â¸ ì¼ì‹œì •ì§€';
  }
  isPlaying = !isPlaying;
}

function onYouTubeIframeAPIReady() { renderPlaylistSelect(); renderSongs(); }

const tag = document.createElement('script');
tag.src = "https://www.youtube.com/iframe_api";
document.head.appendChild(tag);
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ğŸµ ìœ íŠœë¸Œ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ë¡œê·¸ì¸</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 40px auto;
      padding: 20px;
      width: 800px;
    }
    input, button, select {
      padding: 10px;
      margin: 5px 0;
      font-size: 16px;
    }
    .hidden {
      display: none;
    }
    .section {
      margin: 20px 0;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    li {
      background: #f9f9f9;
      margin: 8px 0;
      padding: 8px;
      display: flex;
      align-items: center;
      border: 1px solid #ccc;
      border-radius: 6px;
      gap: 10px;
    }
    .song-title {
      flex-grow: 1;
      color: blue;
      cursor: pointer;
      text-decoration: underline;
    }
    img.thumbnail {
      width: 80px;
      height: 45px;
      object-fit: cover;
      border-radius: 4px;
    }
    #playerContainer {
      text-align: center;
      margin-top: 20px;
    }
    #currentSongTitle {
      font-weight: bold;
      margin-top: 10px;
      min-height: 1.5em;
    }
  </style>
</head>
<body>

<!-- ë¡œê·¸ì¸/íšŒì›ê°€ì… í˜ì´ì§€ -->
<div id="authPage">
  <h2>ğŸ” ë¡œê·¸ì¸</h2>
  <div class="section">
    <input type="text" id="loginId" placeholder="ì•„ì´ë””">
    <input type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸">
    <button onclick="login()">ë¡œê·¸ì¸</button>
  </div>

  <h2>ğŸ“ íšŒì›ê°€ì…</h2>
  <div class="section">
    <input type="text" id="registerId" placeholder="ì•„ì´ë””">
    <input type="password" id="registerPw" placeholder="ë¹„ë°€ë²ˆí˜¸">
    <button onclick="register()">íšŒì›ê°€ì…</button>
  </div>
</div>

<!-- í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ í˜ì´ì§€ -->
<div id="mainPage" class="hidden">
  <h2>ğŸµ ìœ íŠœë¸Œ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸</h2>

  <div>
    <select id="playlistSelect"></select>
    <input type="text" id="newPlaylistName" placeholder="ìƒˆ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì´ë¦„">
    <button onclick="createPlaylist()">â• ìƒì„±</button>
    <button onclick="deletePlaylist()">ğŸ—‘ ì‚­ì œ</button>
    <span id="playlistTitleDisplay"></span>
    <button onclick="editTitle()">âœï¸ ìˆ˜ì •</button>
  </div>

  <input type="text" id="urlInput" placeholder="ìœ íŠœë¸Œ ë§í¬ ë˜ëŠ” ID ì…ë ¥">
  <button onclick="addSong()">ğŸ¶ ì¶”ê°€</button>
  <button onclick="selectAll(true)">â˜‘ ì „ì²´ ì„ íƒ</button>
  <button onclick="selectAll(false)">â˜ ì „ì²´ í•´ì œ</button>
  <input type="number" id="repeatCount" min="1" value="1" style="width: 80px;">íšŒ ë°˜ë³µ
  <button onclick="playSelected()">â–¶ ì„ íƒ ì¬ìƒ</button>

  <ul id="playlist"></ul>

  <div id="playerContainer">
    <div id="player"></div>
    <div id="currentSongTitle"></div>
    <div>
      <button onclick="prevSong()">â® ì´ì „ê³¡</button>
      <button onclick="togglePlayPause()" id="playPauseBtn">âµ ì¬ìƒ</button>
      <button onclick="nextSong()">â­ ë‹¤ìŒê³¡</button>
    </div>
  </div>
  <button onclick="logout()">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
</div>

<script>
  const users = JSON.parse(localStorage.getItem('users') || '{}');
  let currentUser = localStorage.getItem('currentUser');
  let playlists = [], currentPlaylistIndex = 0;
  let playingList = [], currentPlayIndex = 0;
  let player, isPlaying = false;
  let repeatLimit = 1, currentRepeat = 0;

  window.onload = () => {
    if (currentUser) {
      document.getElementById('authPage').classList.add('hidden');
      document.getElementById('mainPage').classList.remove('hidden');
      loadPlaylists();
    }
  }

  function register() {
    const id = document.getElementById('registerId').value.trim();
    const pw = document.getElementById('registerPw').value;
    if (!id || !pw) return alert('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
    if (users[id]) return alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.');
    users[id] = pw;
    localStorage.setItem('users', JSON.stringify(users));
    alert('íšŒì›ê°€ì… ì™„ë£Œ!');
    document.getElementById('registerId').value = '';
    document.getElementById('registerPw').value = '';
  }

  function login() {
    const id = document.getElementById('loginId').value.trim();
    const pw = document.getElementById('loginPw').value;
    if (users[id] === pw) {
      localStorage.setItem('currentUser', id);
      location.reload();
    } else {
      alert('ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤.');
    }
  }

  function logout() {
    localStorage.removeItem('currentUser');
    location.reload();
  }

  function savePlaylists() {
    localStorage.setItem(`playlists_${currentUser}`, JSON.stringify(playlists));
    renderPlaylistSelect();
    renderSongs();
  }

  function loadPlaylists() {
    playlists = JSON.parse(localStorage.getItem(`playlists_${currentUser}`) || '[]');
    renderPlaylistSelect();
    renderSongs();
  }

  function renderPlaylistSelect() {
    const select = document.getElementById('playlistSelect');
    select.innerHTML = '';
    playlists.forEach((p, i) => {
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = p.title;
      select.appendChild(opt);
    });
    select.value = currentPlaylistIndex;
    document.getElementById('playlistTitleDisplay').textContent = `[â†’ ${playlists[currentPlaylistIndex]?.title || ''}]`;
  }

  function createPlaylist() {
    const name = document.getElementById('newPlaylistName').value.trim();
    if (!name) return alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
    playlists.push({ title: name, songs: [] });
    currentPlaylistIndex = playlists.length - 1;
    document.getElementById('newPlaylistName').value = '';
    savePlaylists();
  }

  function deletePlaylist() {
    if (playlists.length <= 1) return alert('ìµœì†Œ í•˜ë‚˜ëŠ” ë‚¨ê²¨ì•¼ í•©ë‹ˆë‹¤');
    if (confirm('ì •ë§ ì‚­ì œí• ê¹Œìš”?')) {
      playlists.splice(currentPlaylistIndex, 1);
      currentPlaylistIndex = 0;
      savePlaylists();
    }
  }

  function editTitle() {
    const newTitle = prompt('ìƒˆ ì œëª©:', playlists[currentPlaylistIndex].title);
    if (newTitle) {
      playlists[currentPlaylistIndex].title = newTitle;
      savePlaylists();
    }
  }

  document.getElementById('playlistSelect').onchange = (e) => {
    currentPlaylistIndex = parseInt(e.target.value);
    renderPlaylistSelect();
    renderSongs();
  };

  async function addSong() {
    const input = document.getElementById('urlInput');
    const id = extractVideoId(input.value);
    if (!id) return alert('ì˜ëª»ëœ ë§í¬ì…ë‹ˆë‹¤');
    const meta = await getYoutubeMeta(id);
    if (!meta) return alert('ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤');
    playlists[currentPlaylistIndex].songs.push({ id, ...meta });
    input.value = '';
    savePlaylists();
  }

  function renderSongs() {
    const ul = document.getElementById('playlist');
    ul.innerHTML = '';
    playlists[currentPlaylistIndex].songs.forEach((s, i) => {
      const li = document.createElement('li');
      li.innerHTML = `
        <input type="checkbox" class="song-checkbox" data-index="${i}">
        <img class="thumbnail" src="${s.thumb}">
        <span class="song-title" onclick="openInNewTab('${s.id}')">${s.title}</span>
        <button onclick="removeSong(${i})">ğŸ—‘</button>`;
      ul.appendChild(li);
    });
  }

  function openInNewTab(id) {
    window.open(`https://www.youtube.com/watch?v=${id}`, '_blank');
  }

  function removeSong(index) {
    playlists[currentPlaylistIndex].songs.splice(index, 1);
    savePlaylists();
  }

  function selectAll(state) {
    document.querySelectorAll('.song-checkbox').forEach(cb => cb.checked = state);
  }

  function extractVideoId(input) {
    input = input.trim();
    if (/^[\w-]{11}$/.test(input)) return input;
    try {
      const url = new URL(input);
      return url.hostname.includes('youtu.be') ? url.pathname.slice(1) : url.searchParams.get('v');
    } catch (e) { return null; }
  }

  async function getYoutubeMeta(id) {
    const res = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${id}&key=AIzaSyD5XkEw4xe9tN0b2pzU2lgiBap72NXiyYM`);
    const data = await res.json();
    const item = data.items?.[0];
    return item ? { title: item.snippet.title, thumb: item.snippet.thumbnails.default.url } : null;
  }

  function playSelected() {
    playingList = [];
    document.querySelectorAll('.song-checkbox').forEach(cb => {
      if (cb.checked) playingList.push(playlists[currentPlaylistIndex].songs[cb.dataset.index]);
    });
    if (playingList.length === 0) return alert('ê³¡ì„ ì„ íƒí•˜ì„¸ìš”');
    repeatLimit = parseInt(document.getElementById('repeatCount').value, 10) || 1;
    currentRepeat = 0;
    currentPlayIndex = 0;
    loadPlayer();
  }

  function loadPlayer() {
    if (player) player.loadVideoById(playingList[currentPlayIndex].id);
    else {
      player = new YT.Player('player', {
        height: '360', width: '640',
        videoId: playingList[currentPlayIndex].id,
        events: {
          onReady: e => e.target.playVideo(),
          onStateChange: onPlayerStateChange
        }
      });
    }
    updateTitle();
    isPlaying = true;
    document.getElementById('playPauseBtn').textContent = 'â¸ ì¼ì‹œì •ì§€';
  }

  function onPlayerStateChange(e) {
    if (e.data === YT.PlayerState.ENDED) {
      currentPlayIndex++;
      if (currentPlayIndex >= playingList.length) {
        currentRepeat++;
        if (currentRepeat < repeatLimit) currentPlayIndex = 0;
        else return;
      }
      loadPlayer();
    }
  }

  function updateTitle() {
    document.getElementById('currentSongTitle').textContent = playingList[currentPlayIndex]?.title || '';
  }

  function prevSong() {
    if (currentPlayIndex > 0) {
      currentPlayIndex--;
      loadPlayer();
    }
  }

  function nextSong() {
    if (currentPlayIndex < playingList.length - 1) {
      currentPlayIndex++;
      loadPlayer();
    }
  }

  function togglePlayPause() {
    if (!player) return;
    if (isPlaying) {
      player.pauseVideo();
      document.getElementById('playPauseBtn').textContent = 'âµ ì¬ìƒ';
    } else {
      player.playVideo();
      document.getElementById('playPauseBtn').textContent = 'â¸ ì¼ì‹œì •ì§€';
    }
    isPlaying = !isPlaying;
  }

  function onYouTubeIframeAPIReady() {
    if (currentUser) {
      loadPlaylists();
    }
  }

  const tag = document.createElement('script');
  tag.src = "https://www.youtube.com/iframe_api";
  document.head.appendChild(tag);
</script>

</body>
</html>
